<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Android AMS 原理解读 - 齐欢的博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="齐欢的博客"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="齐欢的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="AMS（ActivityManagerService） 在 Android 中占据着非常重要的地位，它是 Framework 核心服务之一，负责四大组件的统一调度。同时，AMS 也管理着进程、电池、内存及权限。注：文中源码来源于 Android API 30"><meta property="og:type" content="blog"><meta property="og:title" content="Android AMS 原理解读"><meta property="og:url" content="https://qihuan92.github.io/2021/12/22/android-ams/"><meta property="og:site_name" content="齐欢的博客"><meta property="og:description" content="AMS（ActivityManagerService） 在 Android 中占据着非常重要的地位，它是 Framework 核心服务之一，负责四大组件的统一调度。同时，AMS 也管理着进程、电池、内存及权限。注：文中源码来源于 Android API 30"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://raw.githubusercontent.com/qihuan92/figurebed/master/20211224174554.jpg"><meta property="article:published_time" content="2021-12-22T09:05:48.000Z"><meta property="article:modified_time" content="2024-02-05T02:26:43.114Z"><meta property="article:author" content="齐欢"><meta property="article:tag" content="Android"><meta property="article:tag" content="Activity"><meta property="article:tag" content="源码"><meta property="article:tag" content="AMS"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://raw.githubusercontent.com/qihuan92/figurebed/master/20211224174554.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://qihuan92.github.io/2021/12/22/android-ams/"},"headline":"Android AMS 原理解读","image":["https://raw.githubusercontent.com/qihuan92/figurebed/master/20211224174554.jpg"],"datePublished":"2021-12-22T09:05:48.000Z","dateModified":"2024-02-05T02:26:43.114Z","author":{"@type":"Person","name":"齐欢"},"publisher":{"@type":"Organization","name":"齐欢的博客","logo":{"@type":"ImageObject","url":{"text":"QiHuan"}}},"description":"AMS（ActivityManagerService） 在 Android 中占据着非常重要的地位，它是 Framework 核心服务之一，负责四大组件的统一调度。同时，AMS 也管理着进程、电池、内存及权限。注：文中源码来源于 Android API 30"}</script><link rel="canonical" href="https://qihuan92.github.io/2021/12/22/android-ams/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">QiHuan</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/qihuan92"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://raw.githubusercontent.com/qihuan92/figurebed/master/20211224174554.jpg" alt="Android AMS 原理解读"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-12-22T09:05:48.000Z" title="2021/12/22 17:05:48">2021-12-22</time>发表</span><span class="level-item"><time dateTime="2024-02-05T02:26:43.114Z" title="2024/2/5 10:26:43">2024-02-05</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android/">Android</a></span><span class="level-item">15 分钟读完 (大约2247个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Android AMS 原理解读</h1><div class="content"><p>AMS（ActivityManagerService） 在 Android 中占据着非常重要的地位，它是 Framework 核心服务之一，负责四大组件的统一调度。同时，AMS 也管理着进程、电池、内存及权限。<br>注：文中源码来源于 Android API 30</p>
<span id="more"></span>

<h2 id="Zygote-进程"><a href="#Zygote-进程" class="headerlink" title="Zygote 进程"></a>Zygote 进程</h2><p>Zygote 为受精卵的意思，由名称可以看得出来，Zegote 进程的主要作用就是分裂（fork）进程。</p>
<h3 id="Zygote-的启动流程"><a href="#Zygote-的启动流程" class="headerlink" title="Zygote 的启动流程"></a>Zygote 的启动流程</h3><p><img src="https://raw.githubusercontent.com/qihuan92/figurebed/master/20211222174744.jpg" alt="Zygote 的启动流程"><br>app_main.cpp -&gt; <code>main()</code> -&gt; 初始化 AndroidRuntime -&gt; <code>runtime.start()</code> -&gt; </p>
<h4 id="AndroidRuntime-start"><a href="#AndroidRuntime-start" class="headerlink" title="AndroidRuntime.start()"></a>AndroidRuntime.start()</h4><ol>
<li><code>startVM()</code> 启动虚拟机<br>从上述流程可以看出，一个进程包裹了一个虚拟机。</li>
<li><code>startReg()</code> 注册 JNI</li>
<li><code>env -&gt; CallStaticVoidMethod()</code> -&gt; <code>ZygoteInit.main()</code><br>通过 JNI 调用 <code>ZygoteInit.main()</code> 进入到 Java 层。</li>
</ol>
<h4 id="ZygoteInit-main"><a href="#ZygoteInit-main" class="headerlink" title="ZygoteInit.main()"></a>ZygoteInit.main()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZygoteInit</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String argv[])</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">if</span> (!enableLazyPreload) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 1. 预加载信息，加载了一部分 Framework 的资源，以及常用的 Java 类，加快了应用进程的启动</span></span><br><span class="line">            preload(bootTimingsTraceLog);</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 2. 创建 Socket</span></span><br><span class="line">        zygoteServer = <span class="keyword">new</span> <span class="title class_">ZygoteServer</span>(isPrimaryZygote);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            <span class="comment">// 3. 通过 fork，创建 SystemServer 进程</span></span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> forkSystemServer(abiList, zygoteSocketName, zygoteServer);</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">                r.run();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4. 进入循环，等待 AMS 消息，创建线程</span></span><br><span class="line">        caller = zygoteServer.runSelectLoop(abiList);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ZygoteInit.main()</code> 主要做了以下几个事情：</p>
<ol>
<li>预加载<br><img src="https://raw.githubusercontent.com/qihuan92/figurebed/master/20211223105651.jpg" alt="preload() 预加载"></li>
<li>创建 Socket<br>为什么不用 Binder？<ol>
<li>Binder 还没有初始化完成。</li>
<li>Binder 是多线程机制，fork 时容易死锁。</li>
</ol>
</li>
<li><a href="#SystemServer-%E8%BF%9B%E7%A8%8B">fork SystemServer 进程</a><ul>
<li>如果返回的 Runnable 不为空则通过反射执行 <code>SystemServer.main()</code> 方法。</li>
<li>如果返回的 Runnable 为空则标识当前进程为父进程，也就是 Zygote 进程，接着就会执行第四步进行循环等待。</li>
</ul>
</li>
<li>等待 AMS 消息，创建线程</li>
</ol>
<h2 id="SystemServer-进程"><a href="#SystemServer-进程" class="headerlink" title="SystemServer 进程"></a>SystemServer 进程</h2><p>SystemServer 进程是 zygote 进程<strong>第一个</strong> fork 出来的进程，AMS、WMS 以及 PMS 等都是由 SystemServer 进程启动的。<br>我们进入 <code>ZygoteInit.forkSystemServer()</code> 看一下 SystemServer 进程的创建过程：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Runnable <span class="title function_">forkSystemServer</span><span class="params">(String abiList, String socketName, ZygoteServer zygoteServer)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// fork SystemServer 进程，并返回子进程的 pid</span></span><br><span class="line">        pid = Zygote.forkSystemServer(</span><br><span class="line">                    parsedArgs.mUid, parsedArgs.mGid,</span><br><span class="line">                    parsedArgs.mGids,</span><br><span class="line">                    parsedArgs.mRuntimeFlags,</span><br><span class="line">                    <span class="literal">null</span>,</span><br><span class="line">                    parsedArgs.mPermittedCapabilities,</span><br><span class="line">                    parsedArgs.mEffectiveCapabilities);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pid 为 0 表示当前进程为 fork 出来的进程，也就是 SystemServer 进程</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</span><br><span class="line">            waitForSecondaryZygote(socketName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        zygoteServer.closeServerSocket();</span><br><span class="line">        <span class="comment">// 处理 SystemServer 进程</span></span><br><span class="line">        <span class="keyword">return</span> handleSystemServerProcess(parsedArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下边我们经过 <code>ZygoteInit.handleSystemServerProcess()</code> -&gt; <code>ZygoteInit.zygoteInit()</code> -&gt; <code>RuntimeInit.applicationInit()</code> -&gt; <code>RuntimeInit.findStaticMain()</code> 这几个方法的调度，进入了 <code>RuntimeInit.findStaticMain()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuntimeInit</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Runnable <span class="title function_">findStaticMain</span><span class="params">(String className, String[] argv, ClassLoader classLoader)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过反射执行 SystemServer.main() 方法</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cl = Class.forName(className, <span class="literal">true</span>, classLoader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Missing class when invoking static main &quot;</span> + className,</span><br><span class="line">                    ex);</span><br><span class="line">        &#125;</span><br><span class="line">        Method m;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m = cl.getMethod(<span class="string">&quot;main&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String[].class &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Missing static main on &quot;</span> + className, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Problem getting static main on &quot;</span> + className, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">modifiers</span> <span class="operator">=</span> m.getModifiers();</span><br><span class="line">        <span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Main method is not public and static on &quot;</span> + className);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MethodAndArgsCaller</span>(m, argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MethodAndArgsCaller</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="comment">/** method to call */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Method mMethod;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** argument array */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String[] mArgs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MethodAndArgsCaller</span><span class="params">(Method method, String[] args)</span> &#123;</span><br><span class="line">            mMethod = method;</span><br><span class="line">            mArgs = args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在 ZygoteInit.main() 方法中执行</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mMethod.invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; mArgs &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> ex.getCause();</span><br><span class="line">                <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (Error) cause;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>findStaticMain()</code> 返回一个 MethodAndArgsCaller 对象，而 MethodAndArgsCaller 是一个 Runnable 最终在 <a href="#ZygoteInit-main"><code>ZygoteInit.main()</code></a> 中执行。<br>下面我们进入到 <code>SystemServer.main()</code> -&gt; <code>run()</code> 方法看一下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 创建系统 Context</span></span><br><span class="line">    createSystemContext();</span><br><span class="line">    <span class="comment">// 初始化主线模块</span></span><br><span class="line">    ActivityThread.initializeMainlineModules();</span><br><span class="line">    <span class="comment">// 创建 SystemServiceManager</span></span><br><span class="line">    mSystemServiceManager = <span class="keyword">new</span> <span class="title class_">SystemServiceManager</span>(mSystemContext);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 启动系统引导服务，如 AMS、PMS</span></span><br><span class="line">    startBootstrapServices(t);</span><br><span class="line">    <span class="comment">// 启动核心服务，如电池服务</span></span><br><span class="line">    startCoreServices(t);</span><br><span class="line">    <span class="comment">// 启动其他服务，如 WMS</span></span><br><span class="line">    startOtherServices(t);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 开启循环</span></span><br><span class="line">    Looper.loop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="startBootstrapServices"><a href="#startBootstrapServices" class="headerlink" title="startBootstrapServices()"></a>startBootstrapServices()</h3><p>接着进入到 <code>startBootstrapServices()</code> 方法，看下 AMS 的启动：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startBootstrapServices</span><span class="params">(<span class="meta">@NonNull</span> TimingsTraceAndSlog t)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 启动 ATMS（Android 10 之后）</span></span><br><span class="line">    <span class="type">ActivityTaskManagerService</span> <span class="variable">atm</span> <span class="operator">=</span> mSystemServiceManager.startService(ActivityTaskManagerService.Lifecycle.class).getService();</span><br><span class="line">    <span class="comment">// 启动 AMS</span></span><br><span class="line">    mActivityManagerService = ActivityManagerService.Lifecycle.startService(mSystemServiceManager, atm);</span><br><span class="line">    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">    mActivityManagerService.setInstaller(installer);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 将 AMS 保存到 ServiceManager</span></span><br><span class="line">    mActivityManagerService.setSystemProcess();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ActivityTaskManagerService<ol>
<li>创建 Activity 生命周期管理类 ClientLifecycleManager</li>
<li><code>publishBinderService()</code> -&gt; <code>ServiceManager.addServer()</code><br>将 ATM 服务保存到 ServiceManager 中</li>
</ol>
</li>
<li><a href="#ActivityManagerService-%E7%9A%84%E5%88%9B%E5%BB%BA">ActivityManagerService 的创建</a></li>
<li><code>ActivityManagerService.setSystemProcess()</code> 将 AMS 保存到 ServiceManager</li>
</ul>
<h3 id="startOtherServices"><a href="#startOtherServices" class="headerlink" title="startOtherServices()"></a>startOtherServices()</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startOtherServices</span><span class="params">(<span class="meta">@NonNull</span> TimingsTraceAndSlog t)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 创建 WMS</span></span><br><span class="line">    wm = WindowManagerService.main(context, inputManager, !mFirstBoot, mOnlyCore,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PhoneWindowManager</span>(), mActivityManagerService.mActivityTaskManager);</span><br><span class="line">    ServiceManager.addService(Context.WINDOW_SERVICE, wm, <span class="comment">/* allowIsolated= */</span> <span class="literal">false</span>,</span><br><span class="line">            DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 将 WMS 绑定到 AMS</span></span><br><span class="line">    mActivityManagerService.setWindowManager(wm);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 应用的启动</span></span><br><span class="line">    mActivityManagerService.systemReady(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;, t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>startOtherServices()</code> 函数中可以看到启动了很多服务，其中就有 WMS，最后调用<a href="#%E5%90%AF%E5%8A%A8%E9%A1%B5%E9%9D%A2">应用的启动 <code>systemReady()</code> 方法</a>。</p>
<p><img src="https://raw.githubusercontent.com/qihuan92/figurebed/master/20211223141946.jpg" alt="SystemServer 启动流程"></p>
<h2 id="ActivityManagerService"><a href="#ActivityManagerService" class="headerlink" title="ActivityManagerService"></a>ActivityManagerService</h2><h3 id="ActivityManagerService-的创建"><a href="#ActivityManagerService-的创建" class="headerlink" title="ActivityManagerService 的创建"></a>ActivityManagerService 的创建</h3><p>在 ActivityManagerService.Lifecycle 类的构造方法中创建了 ActivityManagerService 对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Lifecycle</span> <span class="keyword">extends</span> <span class="title class_">SystemService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ActivityTaskManagerService sAtm;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Lifecycle</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">        <span class="comment">// 创建 ActivityManagerService 对象</span></span><br><span class="line">        mService = <span class="keyword">new</span> <span class="title class_">ActivityManagerService</span>(context, sAtm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ActivityManagerService <span class="title function_">startService</span><span class="params">(SystemServiceManager ssm, ActivityTaskManagerService atm)</span> &#123;</span><br><span class="line">        sAtm = atm;</span><br><span class="line">        <span class="keyword">return</span> ssm.startService(ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入 ActivityManagerService 的构造方法看下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ActivityManagerService</span><span class="params">(Context systemContext, ActivityTaskManagerService atm)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 调用 ATM 初始化</span></span><br><span class="line">    mActivityTaskManager.initialize(mIntentFirewall, mPendingIntentController,</span><br><span class="line">                DisplayThread.get().getLooper());</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中关键的部分是调用 ATM 的初始化</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityTaskManagerService</span> <span class="keyword">extends</span> <span class="title class_">IActivityTaskManager</span>.Stub &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(IntentFirewall intentFirewall, PendingIntentController intentController, Looper looper)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 创建栈管理对象 ActivityStackSupervisor</span></span><br><span class="line">        mStackSupervisor = createStackSupervisor();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 设置当前任务栈</span></span><br><span class="line">        setRecentTasks(<span class="keyword">new</span> <span class="title class_">RecentTasks</span>(<span class="built_in">this</span>, mStackSupervisor));</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动页面"><a href="#启动页面" class="headerlink" title="启动页面"></a>启动页面</h3><p><code>ActivityManagerService.systemReady()</code></p>
<h3 id="对-Activity-启动的管理"><a href="#对-Activity-启动的管理" class="headerlink" title="对 Activity 启动的管理"></a>对 Activity 启动的管理</h3><p><img src="https://raw.githubusercontent.com/qihuan92/figurebed/master/20211223173158.jpg" alt="Activity 的启动流程"></p>
<p><code>Activity.startActivity()</code> -&gt; <code>Instrumentation.execStartActivity()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Instrumentation</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> ActivityResult <span class="title function_">execStartActivity</span><span class="params">(</span></span><br><span class="line"><span class="params">            Context who, IBinder contextThread, IBinder token, Activity target,</span></span><br><span class="line"><span class="params">            Intent intent, <span class="type">int</span> requestCode, Bundle options)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            intent.migrateExtraStreamToClipData(who);</span><br><span class="line">            intent.prepareToLeaveProcess(who);</span><br><span class="line">            <span class="comment">// 通过 Binder 跨进程调用 ActivityTaskManager 启动 Activity</span></span><br><span class="line">            <span class="comment">// 在 Android 9 之前是通过 AMS 启动的</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> ActivityTaskManager.getService().startActivity(whoThread,</span><br><span class="line">                    who.getBasePackageName(), who.getAttributionTag(), intent,</span><br><span class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()), token,</span><br><span class="line">                    target != <span class="literal">null</span> ? target.mEmbeddedID : <span class="literal">null</span>, requestCode, <span class="number">0</span>, <span class="literal">null</span>, options);</span><br><span class="line">            checkStartActivityResult(result, intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failure from system&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 ServiceManager 获取 ATM 服务，并调用 ATM 服务的 <code>startActivity()</code> 方法启动 Activity。<br>扩展：<code>ActivityTaskManager.getService()</code> 用到了代理模式。</p>
<p>下面我们看一下 <code>startActivity()</code> 的调用链：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-&gt; ActivityTaskManagerService.startActivity()</span><br><span class="line">-&gt; ActivityTaskManagerService.startActivityAsUser()</span><br><span class="line">-&gt; ActivityStarter.startActivityUnchecked()</span><br><span class="line">-&gt; ActivityStarter.startActivityInner()</span><br><span class="line">-&gt; RootWindowContainer.resumeFocusedStacksTopActivities()</span><br><span class="line">-&gt; ActivityStack.resumeFocusedStacksTopActivities()</span><br><span class="line">-&gt; ActivityStack.resumeTopActivityInnerLocked()</span><br><span class="line">-&gt; ActivityStackSupervisor.startSpecificActivity()</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/qihuan92/figurebed/master/20211224151703.jpg" alt="时序图"></p>
<p>后边比较关键的是 <code>ActivityStackSupervisor.startSpecificActivity()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ActivityStackSupervisor.class</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">startSpecificActivity</span><span class="params">(ActivityRecord r, <span class="type">boolean</span> andResume, <span class="type">boolean</span> checkConfig)</span> &#123;</span><br><span class="line">    <span class="comment">// Is this activity&#x27;s application already running?</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">WindowProcessController</span> <span class="variable">wpc</span> <span class="operator">=</span></span><br><span class="line">            mService.getProcessController(r.processName, r.info.applicationInfo.uid);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">knownToBeDead</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// 判断进程是否启动</span></span><br><span class="line">    <span class="keyword">if</span> (wpc != <span class="literal">null</span> &amp;&amp; wpc.hasThread()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            realStartActivityLocked(r, wpc, andResume, checkConfig);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Exception when starting activity &quot;</span></span><br><span class="line">                    + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line">        <span class="comment">// restart the application.</span></span><br><span class="line">        knownToBeDead = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进程不存在的情况，用 Socket 通知 Zygote fork 应用的进程</span></span><br><span class="line">    r.notifyUnknownVisibilityLaunchedForKeyguardTransition();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isTop</span> <span class="operator">=</span> andResume &amp;&amp; r.isTopRunningActivity();</span><br><span class="line">    mService.startProcessAsync(r, knownToBeDead, isTop, isTop ? <span class="string">&quot;top-activity&quot;</span> : <span class="string">&quot;activity&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入到 <code>startSpecificActivity()</code> 方法，</p>
<ol>
<li>如果进程未启动，则用 Socket 通知 Zygote fork 应用的进程，然后用反射的方式调用 <code>ActivityThread.main()</code> 方法。<br>进入 <code>main()</code> 方法后会执行 <code>attach()</code> 方法，此时传入的 system 参数为 <code>false</code>，可以看出 ActivityThread 通过快进程（Binder）的方式将 ActivityThread 传给 AMS。<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ActivityThread</span> <span class="keyword">extends</span> <span class="title class_">ClientTransactionHandler</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="type">ActivityThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityThread</span>();</span><br><span class="line">        thread.attach(<span class="literal">false</span>, startSeq);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">(<span class="type">boolean</span> system, <span class="type">long</span> startSeq)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">if</span> (!system) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 通过跨进程(Binder)的方式将 ActivityThread 传给 AMS</span></span><br><span class="line">            RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">            <span class="keyword">final</span> <span class="type">IActivityManager</span> <span class="variable">mgr</span> <span class="operator">=</span> ActivityManager.getService();</span><br><span class="line">            mgr.attachApplication(mAppThread, startSeq);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>如果应用程序已启动，则调用 <code>realStartActivityLocked()</code> 方法，执行 Activity 的生命周期。</li>
</ol>
<h3 id="AMS-如何管理新的进程的-Activity-的生命周期"><a href="#AMS-如何管理新的进程的-Activity-的生命周期" class="headerlink" title="AMS 如何管理新的进程的 Activity 的生命周期"></a>AMS 如何管理新的进程的 Activity 的生命周期</h3><p><img src="https://raw.githubusercontent.com/qihuan92/figurebed/master/20211224155214.jpg" alt="生命周期管理"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ActivityStackSupervisor.class</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">realStartActivityLocked</span><span class="params">(ActivityRecord r, WindowProcessController proc, <span class="type">boolean</span> andResume, <span class="type">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Create activity launch transaction.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ClientTransaction</span> <span class="variable">clientTransaction</span> <span class="operator">=</span> ClientTransaction.obtain(</span><br><span class="line">            proc.getThread(), r.appToken);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">DisplayContent</span> <span class="variable">dc</span> <span class="operator">=</span> r.getDisplay().mDisplayContent;</span><br><span class="line">    <span class="comment">// create start</span></span><br><span class="line">    clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> <span class="title class_">Intent</span>(r.intent),</span><br><span class="line">            System.identityHashCode(r), r.info,</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">            <span class="comment">// and override configs.</span></span><br><span class="line">            mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">            mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">            r.launchedFromPackage, task.voiceInteractor, proc.getReportedProcState(),</span><br><span class="line">            r.getSavedState(), r.getPersistentSavedState(), results, newIntents,</span><br><span class="line">            dc.isNextTransitionForward(), proc.createProfilerInfoIfNeeded(),</span><br><span class="line">            r.assistToken, r.createFixedRotationAdjustmentsIfNeeded()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set desired final state.</span></span><br><span class="line">    <span class="keyword">final</span> ActivityLifecycleItem lifecycleItem;</span><br><span class="line">    <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">        <span class="comment">// resume</span></span><br><span class="line">        lifecycleItem = ResumeActivityItem.obtain(dc.isNextTransitionForward());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Schedule transaction.</span></span><br><span class="line">    mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着就会调用 <code>ClientLifecycleManager.scheduleTransaction()</code> 方法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-&gt; ClientLifecycleManager.scheduleTransaction()</span><br><span class="line">-&gt; ClientTransaction.schedule()</span><br><span class="line">-&gt; IApplicationThread.scheduleTransaction()</span><br><span class="line">   -&gt; ActivityThread.ApplicationThread.scheduleTransaction()</span><br><span class="line">   -&gt; ActivityThread.scheduleTransaction()</span><br><span class="line">      -&gt; ActivityThread.H.handleMessage()</span><br><span class="line">      -&gt; msg=EXECUTE_TRANSACTION =&gt; TransactionExecutor.excute()</span><br><span class="line">      -&gt; executeCallbacks() =&gt; LaunchActivityItem</span><br><span class="line">      -&gt; executeLifecycleState() =&gt; state=ON_START &amp; state=ON_RESUME</span><br></pre></td></tr></table></figure>

<h2 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h2><h3 id="为什么使用-Zygote-fork-应用进程，而不是用-Init-或者-SystemServer？"><a href="#为什么使用-Zygote-fork-应用进程，而不是用-Init-或者-SystemServer？" class="headerlink" title="为什么使用 Zygote fork 应用进程，而不是用 Init 或者 SystemServer？"></a>为什么使用 Zygote fork 应用进程，而不是用 Init 或者 SystemServer？</h3><ol>
<li>虚拟机的启动是在 Zygote 进程的，在 Init 进程虚拟机还没有启动；Init 进程除了启动 Zygote 进程，还会启动的一些其他进程，而这些进程与应用进程不相关。</li>
<li>SystemServer 会启动 AMS、WMS、PMS 等很多系统服务，这些服务是所有的应用进程公用的。</li>
</ol>
<h3 id="SystemServiceManager-和-ServiceManager-的区别"><a href="#SystemServiceManager-和-ServiceManager-的区别" class="headerlink" title="SystemServiceManager 和 ServiceManager 的区别"></a>SystemServiceManager 和 ServiceManager 的区别</h3><ol>
<li>SystemServiceManager 是专门用来管理 SystemService 的生命周期的，例如 ActivityManagerService.Lifecycle 和 ActivityTaskManagerService.Lifecycle 等。</li>
<li>ServiceManager 是用来管理系统服务的，ServiceManager 通过 <code>addService()</code> 方法添加服务，通过 <code>getService()</code> 获取服务。</li>
</ol>
<h3 id="如何启动一个未注册的-Activity（插件化原理）"><a href="#如何启动一个未注册的-Activity（插件化原理）" class="headerlink" title="如何启动一个未注册的 Activity（插件化原理）"></a>如何启动一个未注册的 Activity（插件化原理）</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4fc77fbac938">https://www.jianshu.com/p/4fc77fbac938</a><br><a target="_blank" rel="noopener" href="https://woaitqs.cc/2016/08/17/2016-08-17-launch-activity-without-registering-in-manifest/">https://woaitqs.cc/2016/08/17/2016-08-17-launch-activity-without-registering-in-manifest/</a></p>
</blockquote>
<ol>
<li>首先在 AndroidManifest 中注册一个占位的 Activity</li>
<li>在启动 Activity 的地方中的 Intent 里边的目标 Activity 替换为占位 Activity</li>
<li>寻找合适的 hook 点，在 ActivityThread 启动 Activity 的时候，再将占位的 Activity 替换为目标 Activity。</li>
</ol>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Android/">Android</a><a class="link-muted mr-2" rel="tag" href="/tags/Activity/">Activity</a><a class="link-muted mr-2" rel="tag" href="/tags/%E6%BA%90%E7%A0%81/">源码</a><a class="link-muted mr-2" rel="tag" href="/tags/AMS/">AMS</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/12/27/android-handler/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Android Handler 原理分析</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/12/14/android-window/"><span class="level-item">Android Window 机制</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "357724db867108331cd99815bad04664",
            repo: "qihuan92.github.io",
            owner: "qihuan92",
            clientID: "63af65c81b81a45c85dd",
            clientSecret: "f332d0d8c42fecaf6ad773673656cf9bb39ccc70",
            admin: ["qihuan92"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Zygote-进程"><span class="level-left"><span class="level-item">1</span><span class="level-item">Zygote 进程</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Zygote-的启动流程"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">Zygote 的启动流程</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#AndroidRuntime-start"><span class="level-left"><span class="level-item">1.1.1</span><span class="level-item">AndroidRuntime.start()</span></span></a></li><li><a class="level is-mobile" href="#ZygoteInit-main"><span class="level-left"><span class="level-item">1.1.2</span><span class="level-item">ZygoteInit.main()</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#SystemServer-进程"><span class="level-left"><span class="level-item">2</span><span class="level-item">SystemServer 进程</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#startBootstrapServices"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">startBootstrapServices()</span></span></a></li><li><a class="level is-mobile" href="#startOtherServices"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">startOtherServices()</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ActivityManagerService"><span class="level-left"><span class="level-item">3</span><span class="level-item">ActivityManagerService</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ActivityManagerService-的创建"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">ActivityManagerService 的创建</span></span></a></li><li><a class="level is-mobile" href="#启动页面"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">启动页面</span></span></a></li><li><a class="level is-mobile" href="#对-Activity-启动的管理"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">对 Activity 启动的管理</span></span></a></li><li><a class="level is-mobile" href="#AMS-如何管理新的进程的-Activity-的生命周期"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">AMS 如何管理新的进程的 Activity 的生命周期</span></span></a></li></ul></li><li><a class="level is-mobile" href="#面试题"><span class="level-left"><span class="level-item">4</span><span class="level-item">面试题</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#为什么使用-Zygote-fork-应用进程，而不是用-Init-或者-SystemServer？"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">为什么使用 Zygote fork 应用进程，而不是用 Init 或者 SystemServer？</span></span></a></li><li><a class="level is-mobile" href="#SystemServiceManager-和-ServiceManager-的区别"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">SystemServiceManager 和 ServiceManager 的区别</span></span></a></li><li><a class="level is-mobile" href="#如何启动一个未注册的-Activity（插件化原理）"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">如何启动一个未注册的 Activity（插件化原理）</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-07T08:49:54.000Z">2022-11-07</time></p><p class="title"><a href="/2022/11/07/android-apt-activity-starter/">从 startActivity 谈谈 APT 的应用</a></p><p class="categories"><a href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-31T01:48:05.000Z">2021-12-31</time></p><p class="title"><a href="/2021/12/31/iterm-shortcut-key/">iTerm 快捷键速查</a></p><p class="categories"><a href="/categories/%E7%BB%88%E7%AB%AF/">终端</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-27T08:55:36.000Z">2021-12-27</time></p><p class="title"><a href="/2021/12/27/android-handler/">Android Handler 原理分析</a></p><p class="categories"><a href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-22T09:05:48.000Z">2021-12-22</time></p><p class="title"><a href="/2021/12/22/android-ams/">Android AMS 原理解读</a></p><p class="categories"><a href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-14T09:07:51.000Z">2021-12-14</time></p><p class="title"><a href="/2021/12/14/android-window/">Android Window 机制</a></p><p class="categories"><a href="/categories/Android/">Android</a></p></div></article></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">QiHuan</a><p class="is-size-7"><span>&copy; 2024 齐欢</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/qihuan92"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>