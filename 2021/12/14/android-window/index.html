<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Android Window 机制 - 齐欢的博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="齐欢的博客"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="齐欢的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="在 Android 中 View 的绘制流程以及 Activity 和 View 的关系，都离不开 Window，本文将介绍 Window 的概念，以及在 Android 系统中的作用。在文末会放上几个与 WMS 有关的面试题，已巩固这部分知识点。注：文中源码来源于 Android API 30"><meta property="og:type" content="blog"><meta property="og:title" content="Android Window 机制"><meta property="og:url" content="https://qihuan92.github.io/2021/12/14/android-window/"><meta property="og:site_name" content="齐欢的博客"><meta property="og:description" content="在 Android 中 View 的绘制流程以及 Activity 和 View 的关系，都离不开 Window，本文将介绍 Window 的概念，以及在 Android 系统中的作用。在文末会放上几个与 WMS 有关的面试题，已巩固这部分知识点。注：文中源码来源于 Android API 30"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://images.unsplash.com/photo-1518286602730-0829d2fdd245?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2670&amp;q=80"><meta property="article:published_time" content="2021-12-14T09:07:51.000Z"><meta property="article:modified_time" content="2024-02-05T02:26:43.115Z"><meta property="article:author" content="齐欢"><meta property="article:tag" content="Android"><meta property="article:tag" content="源码"><meta property="article:tag" content="View"><meta property="article:tag" content="Window"><meta property="article:tag" content="WMS"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://images.unsplash.com/photo-1518286602730-0829d2fdd245?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2670&amp;q=80"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://qihuan92.github.io/2021/12/14/android-window/"},"headline":"Android Window 机制","image":[],"datePublished":"2021-12-14T09:07:51.000Z","dateModified":"2024-02-05T02:26:43.115Z","author":{"@type":"Person","name":"齐欢"},"publisher":{"@type":"Organization","name":"齐欢的博客","logo":{"@type":"ImageObject","url":{"text":"QiHuan"}}},"description":"在 Android 中 View 的绘制流程以及 Activity 和 View 的关系，都离不开 Window，本文将介绍 Window 的概念，以及在 Android 系统中的作用。在文末会放上几个与 WMS 有关的面试题，已巩固这部分知识点。注：文中源码来源于 Android API 30"}</script><link rel="canonical" href="https://qihuan92.github.io/2021/12/14/android-window/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">QiHuan</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/qihuan92"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://images.unsplash.com/photo-1518286602730-0829d2fdd245?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2670&amp;q=80" alt="Android Window 机制"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-12-14T09:07:51.000Z" title="2021/12/14 17:07:51">2021-12-14</time>发表</span><span class="level-item"><time dateTime="2024-02-05T02:26:43.115Z" title="2024/2/5 10:26:43">2024-02-05</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android/">Android</a></span><span class="level-item">27 分钟读完 (大约4039个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Android Window 机制</h1><div class="content"><p>在 Android 中 View 的绘制流程以及 Activity 和 View 的关系，都离不开 Window，本文将介绍 Window 的概念，以及在 Android 系统中的作用。在文末会放上几个与 WMS 有关的面试题，已巩固这部分知识点。<br>注：文中源码来源于 Android API 30</p>
<span id="more"></span>

<h2 id="Window-存在的意义"><a href="#Window-存在的意义" class="headerlink" title="Window 存在的意义"></a>Window 存在的意义</h2><p>Window 的概念在用户界面中是比较重要的，比如 Windows、MacOS 系统，View 都是显示在各个独立窗口中的，可以说 Window 是对 View 载体。在 Android 中，为了管理各 Window，Android 在系统进程中创建了一个系统服务 WindowManagerService，而 View 只能显示在对应的 Window 中。由于每一个 App 都是一个进程，所以 WMS 设计为系统进程，以方便统一管理。</p>
<h2 id="Activity、Window-和-View-的关系"><a href="#Activity、Window-和-View-的关系" class="headerlink" title="Activity、Window 和 View 的关系"></a>Activity、Window 和 View 的关系</h2><p>每个 App 都可以有很多窗口，为了方便管理页面的跳转回退逻辑，Android 系统为了单一职责封装了 Activity，并将 Activity 放入到栈中，并由 AMS 统一调度，又通过迪米特法则将 Window 屏蔽，并暴露了各个生命周期方法，让开发者专注于 View 的开发。</p>
<p>每个 Activity 包含了一个 Window（由 PhoneWindow 实现）。而 PhoneWindow 将 DecorView 作为了一个应用窗口的根 View，DecorView 又把屏幕划分为了两个区域：一个是 TitleView，也就是 ActionBar 或者 TitleBar，一个是 ContentView，通过 <code>setContentView()</code> 设置。</p>
<p>层级关系如下图所示：<br><img src="https://raw.githubusercontent.com/qihuan92/figurebed/master/63dec664-5f18-11ec-bf63-0242ac130002.png" alt="Activity、Window 和 View 的关系"></p>
<h3 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h3><p>Activity 不处理加载视图的逻辑，在 <code>attach()</code> 的时候创建 Window 对象，在 <code>onResume()</code> 后通过 WindowManager 添加 View。</p>
<h3 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h3><p>每一个 Window 都管理着一个 View 树，View 必须依附在 Window 中才能展示。Activity 内部可以有多个窗口，例如在页面上弹出一个 Dialog，其中 Dialog 是一个单独的窗口。View 的测量、布局和绘制动作都是在一个 View 树种进行的，所以窗口之间 View 的改动是互不影响的。</p>
<h3 id="WindowManager"><a href="#WindowManager" class="headerlink" title="WindowManager"></a>WindowManager</h3><p>WindowManager 是 Window 的管理类，但不直接管理 Window。WindowManager 与 Window 之间的关系是一个典型的桥接模式。而 WindowManager 使用 WindowManagerGlobal 通过 IWindowManager 接口与 WindowManagerService （也就是 WMS）进行交互，并由 WMS 完成具体的窗口管理工作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Window</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Set the window manager for use by this Window to, for example,</span></span><br><span class="line"><span class="comment">   * display panels.  This is &lt;em&gt;not&lt;/em&gt; used for displaying the</span></span><br><span class="line"><span class="comment">   * Window itself -- that must be done by the client.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> wm The window manager for adding new windows.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWindowManager</span><span class="params">(WindowManager wm, IBinder appToken, String appName,</span></span><br><span class="line"><span class="params">          <span class="type">boolean</span> hardwareAccelerated)</span> &#123;</span><br><span class="line">      mAppToken = appToken;</span><br><span class="line">      mAppName = appName;</span><br><span class="line">      <span class="comment">// 默认关闭硬件加速</span></span><br><span class="line">      mHardwareAccelerated = hardwareAccelerated</span><br><span class="line">              || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, <span class="literal">false</span>);</span><br><span class="line">      <span class="comment">// 如果传入的 WindowManager 为空，则通过 getSystemService 获取 WindowManager。</span></span><br><span class="line">      <span class="keyword">if</span> (wm == <span class="literal">null</span>) &#123;</span><br><span class="line">          wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将 WindowManager 和 Window 绑定，创建一个 WindowManagerImpl</span></span><br><span class="line">      mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DecorView"><a href="#DecorView" class="headerlink" title="DecorView"></a>DecorView</h3><p>DecorView 是 View 树的顶级 View，它是 FrameLayout 的子类。根据 Activity 设置的 Theme，DecorView 会有不同布局。但无论布局怎么变，DecorView 都有一个 Id 为 R.id.content 的 FrameLayout。<code>Activity.setContentView()</code> 方法就是在这个FrameLayout 中添加子 View 的。</p>
<h3 id="ViewRootImpl"><a href="#ViewRootImpl" class="headerlink" title="ViewRootImpl"></a>ViewRootImpl</h3><p>ViewRootImpl 是连接 WindowManager 和 DecorView 的纽带，View 的测量、布局和绘制均是通过 ViewRootImpl 来完成的。</p>
<h2 id="Activity-是如何通过-Window-将-View-展示出来的"><a href="#Activity-是如何通过-Window-将-View-展示出来的" class="headerlink" title="Activity 是如何通过 Window 将 View 展示出来的"></a>Activity 是如何通过 Window 将 View 展示出来的</h2><p><img src="https://raw.githubusercontent.com/qihuan92/figurebed/master/e2f8d1d2-5f19-11ec-bf63-0242ac130002.webp" alt="View 加载流程"><br>这个需要从 Activity 的启动开始，Activity 的启动是通过 <code>ActivityThread.handleLaunchActivity()</code> 开始的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ActivityThread</span> <span class="keyword">extends</span> <span class="title class_">ClientTransactionHandler</span> &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> &#123;</span><br><span class="line">        <span class="comment">//省略代码...</span></span><br><span class="line">        <span class="comment">//performLaunchActivity</span></span><br><span class="line">        <span class="type">Activity</span> <span class="variable">a</span> <span class="operator">=</span> performLaunchActivity(r, customIntent);</span><br><span class="line">        <span class="keyword">if</span> (a != <span class="literal">null</span>) &#123;</span><br><span class="line">            r.createdConfig = <span class="keyword">new</span> <span class="title class_">Configuration</span>(mConfiguration);</span><br><span class="line">            <span class="type">Bundle</span> <span class="variable">oldState</span> <span class="operator">=</span> r.state;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//handleResumeActivity</span></span><br><span class="line">            handleResumeActivity(r.token, <span class="literal">false</span>, r.isForward,!r.activity.mFinished &amp;&amp; !r.startsNotResumed);</span><br><span class="line">            <span class="comment">//省略代码...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="#1-performLaunchActivity"><code>performLaunchActivity()</code></a><br>完成 Activity 的创建，调用 <code>Activity.attach()</code> 方法，将 Window 创建出来，然后调用 <code>Activity.onCreate()</code> 方法。</li>
<li><a href="#2-handleResumeActivity"><code>handleResumeActivity()</code></a><br>调用 <code>Activity.onResume()</code> 方法，处理 View 的展示。</li>
</ul>
<h3 id="1-performLaunchActivity"><a href="#1-performLaunchActivity" class="headerlink" title="1. performLaunchActivity()"></a>1. performLaunchActivity()</h3><p>以下为 <code>performLaunchActivity()</code> 方法的核心代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ActivityThread</span> <span class="keyword">extends</span> <span class="title class_">ClientTransactionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Activity <span class="title function_">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> &#123;</span><br><span class="line">        <span class="type">ActivityInfo</span> <span class="variable">aInfo</span> <span class="operator">=</span> r.activityInfo;</span><br><span class="line">        <span class="keyword">if</span> (r.packageInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                    Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ComponentName</span> <span class="variable">component</span> <span class="operator">=</span> r.intent.getComponent();</span><br><span class="line">        <span class="keyword">if</span> (component == <span class="literal">null</span>) &#123;</span><br><span class="line">            component = r.intent.resolveActivity(</span><br><span class="line">                mInitialApplication.getPackageManager());</span><br><span class="line">            r.intent.setComponent(component);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="literal">null</span>) &#123;</span><br><span class="line">            component = <span class="keyword">new</span> <span class="title class_">ComponentName</span>(r.activityInfo.packageName,</span><br><span class="line">                    r.activityInfo.targetActivity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 Context</span></span><br><span class="line">        <span class="type">ContextImpl</span> <span class="variable">appContext</span> <span class="operator">=</span> createBaseContextForActivity(r);</span><br><span class="line">        <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.<span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> appContext.getClassLoader();</span><br><span class="line">            <span class="comment">// 创建 Activity</span></span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">            r.intent.setExtrasClassLoader(cl);</span><br><span class="line">            r.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="keyword">if</span> (r.state != <span class="literal">null</span>) &#123;</span><br><span class="line">                r.state.setClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Unable to instantiate activity &quot;</span> + component</span><br><span class="line">                    + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> r.packageInfo.makeApplication(<span class="literal">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Performing launch of &quot;</span> + r);</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                    TAG, r + <span class="string">&quot;: app=&quot;</span> + app</span><br><span class="line">                    + <span class="string">&quot;, appName=&quot;</span> + app.getPackageName()</span><br><span class="line">                    + <span class="string">&quot;, pkg=&quot;</span> + r.packageInfo.getPackageName()</span><br><span class="line">                    + <span class="string">&quot;, comp=&quot;</span> + r.intent.getComponent().toShortString()</span><br><span class="line">                    + <span class="string">&quot;, dir=&quot;</span> + r.packageInfo.getAppDir());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">CharSequence</span> <span class="variable">title</span> <span class="operator">=</span> r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">                <span class="type">Configuration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(mCompatConfiguration);</span><br><span class="line">                <span class="keyword">if</span> (r.overrideConfig != <span class="literal">null</span>) &#123;</span><br><span class="line">                    config.updateFrom(r.overrideConfig);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">&quot;Launching activity &quot;</span></span><br><span class="line">                        + r.activityInfo.name + <span class="string">&quot; with config &quot;</span> + config);</span><br><span class="line">                <span class="type">Window</span> <span class="variable">window</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="literal">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">                    window = r.mPendingRemoveWindow;</span><br><span class="line">                    r.mPendingRemoveWindow = <span class="literal">null</span>;</span><br><span class="line">                    r.mPendingRemoveWindowManager = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Activity resources must be initialized with the same loaders as the</span></span><br><span class="line">                <span class="comment">// application context.</span></span><br><span class="line">                appContext.getResources().addLoaders(</span><br><span class="line">                        app.getResources().getLoaders().toArray(<span class="keyword">new</span> <span class="title class_">ResourcesLoader</span>[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">                appContext.setOuterContext(activity);</span><br><span class="line">                <span class="comment">// **调用 Activity.attach() 方法**</span></span><br><span class="line">                activity.attach(appContext, <span class="built_in">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window, r.configCallback,</span><br><span class="line">                        r.assistToken);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (customIntent != <span class="literal">null</span>) &#123;</span><br><span class="line">                    activity.mIntent = customIntent;</span><br><span class="line">                &#125;</span><br><span class="line">                r.lastNonConfigurationInstances = <span class="literal">null</span>;</span><br><span class="line">                checkAndBlockForNetworkAccess();</span><br><span class="line">                activity.mStartedActivity = <span class="literal">false</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">theme</span> <span class="operator">=</span> r.activityInfo.getThemeResource();</span><br><span class="line">                <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                    activity.setTheme(theme);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 调用 Activity.onCreate() 方法</span></span><br><span class="line">                activity.mCalled = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SuperNotCalledException</span>(</span><br><span class="line">                        <span class="string">&quot;Activity &quot;</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                        <span class="string">&quot; did not call through to super.onCreate()&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.activity = activity;</span><br><span class="line">                mLastReportedWindowingMode.put(activity.getActivityToken(),</span><br><span class="line">                        config.windowConfiguration.getWindowingMode());</span><br><span class="line">            &#125;</span><br><span class="line">            r.setState(ON_CREATE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// updatePendingActivityConfiguration() reads from mActivities to update</span></span><br><span class="line">            <span class="comment">// ActivityClientRecord which runs in a different thread. Protect modifications to</span></span><br><span class="line">            <span class="comment">// mActivities to avoid race.</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">                mActivities.put(r.token, r);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Unable to start activity &quot;</span> + component</span><br><span class="line">                    + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>performLaunchActivity()</code> 方法主要做了以下几个事情：</p>
<ul>
<li>创建 Context</li>
<li>创建 Activity</li>
<li><a href="#Activity-attach">调用 <code>Activity.attach()</code> 创建 Window，并关联 WindowManager</a></li>
<li>调用 <code>Activity.onCreate()</code> 方法</li>
</ul>
<h4 id="Activity-attach"><a href="#Activity-attach" class="headerlink" title="Activity.attach()"></a>Activity.attach()</h4><p>在 <code>performLaunchActivity()</code> 代码中，创建 Window 的逻辑是在 <code>Activity.attach()</code> 方法中的，我们跟进来看下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Activity</span> <span class="keyword">extends</span> <span class="title class_">ContextThemeWrapper</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LayoutInflater</span>.Factory2,</span><br><span class="line">        Window.Callback, KeyEvent.Callback,</span><br><span class="line">        OnCreateContextMenuListener, ComponentCallbacks2,</span><br><span class="line">        Window.OnWindowDismissedCallback,</span><br><span class="line">        AutofillManager.AutofillClient, ContentCaptureManager.ContentCaptureClient &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span><br><span class="line"><span class="params">            Instrumentation instr, IBinder token, <span class="type">int</span> ident,</span></span><br><span class="line"><span class="params">            Application application, Intent intent, ActivityInfo info,</span></span><br><span class="line"><span class="params">            CharSequence title, Activity parent, String id,</span></span><br><span class="line"><span class="params">            NonConfigurationInstances lastNonConfigurationInstances,</span></span><br><span class="line"><span class="params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span><br><span class="line"><span class="params">            Window window, ActivityConfigCallback activityConfigCallback, IBinder assistToken)</span> &#123;</span><br><span class="line">        attachBaseContext(context);</span><br><span class="line"></span><br><span class="line">        mFragments.attachHost(<span class="literal">null</span> <span class="comment">/*parent*/</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 Window</span></span><br><span class="line">        mWindow = <span class="keyword">new</span> <span class="title class_">PhoneWindow</span>(<span class="built_in">this</span>, window, activityConfigCallback);</span><br><span class="line">        mWindow.setWindowControllerCallback(mWindowControllerCallback);</span><br><span class="line">        mWindow.setCallback(<span class="built_in">this</span>);</span><br><span class="line">        mWindow.setOnWindowDismissedCallback(<span class="built_in">this</span>);</span><br><span class="line">        mWindow.getLayoutInflater().setPrivateFactory(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</span><br><span class="line">            mWindow.setSoftInputMode(info.softInputMode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (info.uiOptions != <span class="number">0</span>) &#123;</span><br><span class="line">            mWindow.setUiOptions(info.uiOptions);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置 UI 线程</span></span><br><span class="line">        mUiThread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        mMainThread = aThread;</span><br><span class="line">        mInstrumentation = instr;</span><br><span class="line">        mToken = token;</span><br><span class="line">        mAssistToken = assistToken;</span><br><span class="line">        mIdent = ident;</span><br><span class="line">        mApplication = application;</span><br><span class="line">        mIntent = intent;</span><br><span class="line">        mReferrer = referrer;</span><br><span class="line">        mComponent = intent.getComponent();</span><br><span class="line">        mActivityInfo = info;</span><br><span class="line">        mTitle = title;</span><br><span class="line">        mParent = parent;</span><br><span class="line">        mEmbeddedID = id;</span><br><span class="line">        mLastNonConfigurationInstances = lastNonConfigurationInstances;</span><br><span class="line">        <span class="keyword">if</span> (voiceInteractor != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lastNonConfigurationInstances != <span class="literal">null</span>) &#123;</span><br><span class="line">                mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mVoiceInteractor = <span class="keyword">new</span> <span class="title class_">VoiceInteractor</span>(voiceInteractor, <span class="built_in">this</span>, <span class="built_in">this</span>,</span><br><span class="line">                        Looper.myLooper());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Window 与 WindowManager 建立关联</span></span><br><span class="line">        mWindow.setWindowManager(</span><br><span class="line">                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">                mToken, mComponent.flattenToString(),</span><br><span class="line">                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (mParent != <span class="literal">null</span>) &#123;</span><br><span class="line">            mWindow.setContainer(mParent.getWindow());</span><br><span class="line">        &#125;</span><br><span class="line">        mWindowManager = mWindow.getWindowManager();</span><br><span class="line">        mCurrentConfig = config;</span><br><span class="line"></span><br><span class="line">        mWindow.setColorMode(info.colorMode);</span><br><span class="line">        mWindow.setPreferMinimalPostProcessing(</span><br><span class="line">                (info.flags &amp; ActivityInfo.FLAG_PREFER_MINIMAL_POST_PROCESSING) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        setAutofillOptions(application.getAutofillOptions());</span><br><span class="line">        setContentCaptureOptions(application.getContentCaptureOptions());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Activity.attach()</code> 方法主要做了以下几个事情：</p>
<ul>
<li>创建 Window 对象</li>
<li>给 Window 设置 WindowManager</li>
<li>设置 UI 线程</li>
</ul>
<h4 id="Activity-setContentView"><a href="#Activity-setContentView" class="headerlink" title="Activity.setContentView()"></a>Activity.setContentView()</h4><p>通常我们会在 <code>Activity.onCreate()</code> 方法中调用 <code>setContentView()</code> 方法，将 View 设置到当前页面中。<code>Activity.setContentView()</code> 又调用了 <code>PhoneWindow.setContentView()</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneWindow</span> <span class="keyword">extends</span> <span class="title class_">Window</span> <span class="keyword">implements</span> <span class="title class_">MenuBuilder</span>.Callback &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DecorView mDecor;</span><br><span class="line">    <span class="comment">// setContentView() 传过来的 View 会被加载到到 mContentParent 中。mContentParent 的 Id是 R.id.content</span></span><br><span class="line">    <span class="keyword">private</span> ViewGroup mContentParent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContentView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="literal">null</span>) &#123;</span><br><span class="line">            installDecor();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            mContentParent.removeAllViews();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installDecor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDecor == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 初始化 DecorView</span></span><br><span class="line">            mDecor = generateDecor();</span><br><span class="line">            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">            mDecor.setIsRootNamespace(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != <span class="number">0</span>) &#123;</span><br><span class="line">                mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="literal">null</span>) &#123;</span><br><span class="line">            mContentParent = generateLayout(mDecor);</span><br><span class="line">            <span class="comment">// 省略...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首次加载时，会执行 <code>installDecor()</code> 方法初始化 DecorView，调用 <code>Activity.setContentView()</code> 方法就会将 View 添加到 ID 为 R.id.content 的 FrameLayout 中。</p>
<h3 id="2-handleResumeActivity"><a href="#2-handleResumeActivity" class="headerlink" title="2. handleResumeActivity()"></a>2. handleResumeActivity()</h3><p>以下为 <code>handleResumeActivity()</code> 的核心代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ActivityThread</span> <span class="keyword">extends</span> <span class="title class_">ClientTransactionHandler</span> &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleResumeActivity</span><span class="params">(IBinder token, <span class="type">boolean</span> finalStateRequest, <span class="type">boolean</span> isForward,</span></span><br><span class="line"><span class="params">            String reason)</span> &#123;</span><br><span class="line">        <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">        <span class="comment">// we are back active so skip it.</span></span><br><span class="line">        unscheduleGcIdler();</span><br><span class="line">        mSomeActivitiesChanged = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// **调用 Activity.onResume() 方法**</span></span><br><span class="line">        <span class="comment">// TODO Push resumeArgs into the activity for consideration</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ActivityClientRecord</span> <span class="variable">r</span> <span class="operator">=</span> performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// We didn&#x27;t actually resume the activity, so skipping any follow-up actions.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mActivitiesToBeDestroyed.containsKey(token)) &#123;</span><br><span class="line">            <span class="comment">// Although the activity is resumed, it is going to be destroyed. So the following</span></span><br><span class="line">            <span class="comment">// UI operations are unnecessary and also prevents exception because its token may</span></span><br><span class="line">            <span class="comment">// be gone that window manager cannot recognize it. All necessary cleanup actions</span></span><br><span class="line">            <span class="comment">// performed below will be done while handling destruction.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Activity</span> <span class="variable">a</span> <span class="operator">=</span> r.activity;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (localLOGV) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">&quot;Resume &quot;</span> + r + <span class="string">&quot; started activity: &quot;</span> + a.mStartedActivity</span><br><span class="line">                    + <span class="string">&quot;, hideForNow: &quot;</span> + r.hideForNow + <span class="string">&quot;, finished: &quot;</span> + a.mFinished);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">forwardBit</span> <span class="operator">=</span> isForward</span><br><span class="line">                ? WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the window hasn&#x27;t yet been added to the window manager,</span></span><br><span class="line">        <span class="comment">// and this guy didn&#x27;t finish itself or start another activity,</span></span><br><span class="line">        <span class="comment">// then go ahead and add the window.</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">willBeVisible</span> <span class="operator">=</span> !a.mStartedActivity;</span><br><span class="line">        <span class="keyword">if</span> (!willBeVisible) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                willBeVisible = ActivityTaskManager.getService().willActivityBeVisible(</span><br><span class="line">                        a.getActivityToken());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="literal">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">            r.window = r.activity.getWindow();</span><br><span class="line">            <span class="type">View</span> <span class="variable">decor</span> <span class="operator">=</span> r.window.getDecorView();</span><br><span class="line">            <span class="comment">// 将 DecorView 设置为不可见</span></span><br><span class="line">            decor.setVisibility(View.INVISIBLE);</span><br><span class="line">            <span class="type">ViewManager</span> <span class="variable">wm</span> <span class="operator">=</span> a.getWindowManager();</span><br><span class="line">            WindowManager.<span class="type">LayoutParams</span> <span class="variable">l</span> <span class="operator">=</span> r.window.getAttributes();</span><br><span class="line">            a.mDecor = decor;</span><br><span class="line">            l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">            l.softInputMode |= forwardBit;</span><br><span class="line">            <span class="keyword">if</span> (r.mPreserveWindow) &#123;</span><br><span class="line">                a.mWindowAdded = <span class="literal">true</span>;</span><br><span class="line">                r.mPreserveWindow = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// Normally the ViewRoot sets up callbacks with the Activity</span></span><br><span class="line">                <span class="comment">// in addView-&gt;ViewRootImpl#setView. If we are instead reusing</span></span><br><span class="line">                <span class="comment">// the decor view we have to notify the view root that the</span></span><br><span class="line">                <span class="comment">// callbacks may have changed.</span></span><br><span class="line">                <span class="type">ViewRootImpl</span> <span class="variable">impl</span> <span class="operator">=</span> decor.getViewRootImpl();</span><br><span class="line">                <span class="keyword">if</span> (impl != <span class="literal">null</span>) &#123;</span><br><span class="line">                    impl.notifyChildRebuilt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// **通过 WindowManager 加载 DecorView**</span></span><br><span class="line">            <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!a.mWindowAdded) &#123;</span><br><span class="line">                    a.mWindowAdded = <span class="literal">true</span>;</span><br><span class="line">                    wm.addView(decor, l);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// The activity will get a callback for this &#123;@link LayoutParams&#125; change</span></span><br><span class="line">                    <span class="comment">// earlier. However, at that time the decor will not be set (this is set</span></span><br><span class="line">                    <span class="comment">// in this method), so no action will be taken. This call ensures the</span></span><br><span class="line">                    <span class="comment">// callback occurs with the decor set.</span></span><br><span class="line">                    a.onWindowAttributesChanged(l);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the window has already been added, but during resume</span></span><br><span class="line">            <span class="comment">// we started another activity, then don&#x27;t yet make the</span></span><br><span class="line">            <span class="comment">// window visible.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!willBeVisible) &#123;</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Launch &quot;</span> + r + <span class="string">&quot; mStartedActivity set&quot;</span>);</span><br><span class="line">            r.hideForNow = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get rid of anything left hanging around.</span></span><br><span class="line">        cleanUpPendingRemoveWindows(r, <span class="literal">false</span> <span class="comment">/* force */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The window is now visible if it has been added, we are not</span></span><br><span class="line">        <span class="comment">// simply finishing, and we are not starting another activity.</span></span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible &amp;&amp; r.activity.mDecor != <span class="literal">null</span> &amp;&amp; !r.hideForNow) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r.newConfig != <span class="literal">null</span>) &#123;</span><br><span class="line">                performConfigurationChangedForActivity(r, r.newConfig);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_CONFIGURATION) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">&quot;Resuming activity &quot;</span> + r.activityInfo.name + <span class="string">&quot; with newConfig &quot;</span></span><br><span class="line">                            + r.activity.mCurrentConfig);</span><br><span class="line">                &#125;</span><br><span class="line">                r.newConfig = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Resuming &quot;</span> + r + <span class="string">&quot; with isForward=&quot;</span> + isForward);</span><br><span class="line">            <span class="type">ViewRootImpl</span> <span class="variable">impl</span> <span class="operator">=</span> r.window.getDecorView().getViewRootImpl();</span><br><span class="line">            WindowManager.<span class="type">LayoutParams</span> <span class="variable">l</span> <span class="operator">=</span> impl != <span class="literal">null</span></span><br><span class="line">                    ? impl.mWindowAttributes : r.window.getAttributes();</span><br><span class="line">            <span class="keyword">if</span> ((l.softInputMode</span><br><span class="line">                    &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)</span><br><span class="line">                    != forwardBit) &#123;</span><br><span class="line">                l.softInputMode = (l.softInputMode</span><br><span class="line">                        &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION))</span><br><span class="line">                        | forwardBit;</span><br><span class="line">                <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                    <span class="type">ViewManager</span> <span class="variable">wm</span> <span class="operator">=</span> a.getWindowManager();</span><br><span class="line">                    <span class="type">View</span> <span class="variable">decor</span> <span class="operator">=</span> r.window.getDecorView();</span><br><span class="line">                    wm.updateViewLayout(decor, l);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r.activity.mVisibleFromServer = <span class="literal">true</span>;</span><br><span class="line">            mNumVisibleActivities++;</span><br><span class="line">            <span class="comment">// 将 DecorView 设置为可见状态</span></span><br><span class="line">            <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                r.activity.makeVisible();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r.nextIdle = mNewActivities;</span><br><span class="line">        mNewActivities = r;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Scheduling idle handler for &quot;</span> + r);</span><br><span class="line">        Looper.myQueue().addIdleHandler(<span class="keyword">new</span> <span class="title class_">Idler</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>handleResumeActivity()</code> 方法为本文的重点，主要做了以下几个事情：</p>
<ol>
<li>首先调用了 <code>Activity.onResume()</code> 生命周期</li>
<li>将 DecorView 设置为不可见</li>
<li><a href="#WindowManager-%E5%8A%A0%E8%BD%BD-DecorView">通过 WindowManager 加载 DecorView</a></li>
<li>将 DecorView 设置为可见</li>
</ol>
<h4 id="WindowManager-加载-DecorView"><a href="#WindowManager-加载-DecorView" class="headerlink" title="WindowManager 加载 DecorView"></a>WindowManager 加载 DecorView</h4><p>因为 WindowManagerImpl 为 WindowManger 的实现，所以下面来看一下 <code>WindowMangerImpl.addView()</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WindowManagerImpl</span> <span class="keyword">implements</span> <span class="title class_">WindowManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">WindowManagerGlobal</span> <span class="variable">mGlobal</span> <span class="operator">=</span> WindowManagerGlobal.getInstance();</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">    <span class="keyword">private</span> IBinder mDefaultToken;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the window token to assign when none is specified by the client or</span></span><br><span class="line"><span class="comment">     * available from the parent window.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token The default token to assign.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDefaultToken</span><span class="params">(IBinder token)</span> &#123;</span><br><span class="line">        mDefaultToken = token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addView</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@NonNull</span> ViewGroup.LayoutParams params)</span> &#123;</span><br><span class="line">        applyDefaultToken(params);</span><br><span class="line">        mGlobal.addView(view, params, mContext.getDisplayNoVerify(), mParentWindow,</span><br><span class="line">                mContext.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">applyDefaultToken</span><span class="params">(<span class="meta">@NonNull</span> ViewGroup.LayoutParams params)</span> &#123;</span><br><span class="line">        <span class="comment">// Only use the default token if we don&#x27;t have a parent window.</span></span><br><span class="line">        <span class="keyword">if</span> (mDefaultToken != <span class="literal">null</span> &amp;&amp; mParentWindow == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(params <span class="keyword">instanceof</span> WindowManager.LayoutParams)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Params must be WindowManager.LayoutParams&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Only use the default token if we don&#x27;t already have a token.</span></span><br><span class="line">            <span class="keyword">final</span> WindowManager.<span class="type">LayoutParams</span> <span class="variable">wparams</span> <span class="operator">=</span> (WindowManager.LayoutParams) params;</span><br><span class="line">            <span class="keyword">if</span> (wparams.token == <span class="literal">null</span>) &#123;</span><br><span class="line">                wparams.token = mDefaultToken;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>addView()</code> 方法逻辑很简短，直接调用 <a href="#WindowManagerGlobal-%E5%8A%A0%E8%BD%BD-View"><code>WindowManagerGlobal.addView()</code></a> 方法。在调用之前，还会执 <code>applyDefaultToken()</code> 方法，这个的作用是给 DecorView 加一个身份标识，表示当前的 DecorView 属于那个 Activity，然后将当前的 DecorView 绘制到 Activity 中。</p>
<h4 id="WindowManagerGlobal-加载-View"><a href="#WindowManagerGlobal-加载-View" class="headerlink" title="WindowManagerGlobal 加载 View"></a>WindowManagerGlobal 加载 View</h4><p>紧接着进入 <code>WindowManagerGlobal.addView()</code> 方法，以下为核心代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WindowManagerGlobal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;View&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ViewRootImpl&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;WindowManager.LayoutParams&gt; mParams =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;WindowManager.LayoutParams&gt;();</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span><br><span class="line"><span class="params">            Display display, Window parentWindow, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">        <span class="comment">// 省略一些校验...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> WindowManager.<span class="type">LayoutParams</span> <span class="variable">wparams</span> <span class="operator">=</span> (WindowManager.LayoutParams) params;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">        ViewRootImpl root;</span><br><span class="line">        <span class="type">View</span> <span class="variable">panelParentView</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">            root = <span class="keyword">new</span> <span class="title class_">ViewRootImpl</span>(view.getContext(), display);</span><br><span class="line"></span><br><span class="line">            view.setLayoutParams(wparams);</span><br><span class="line"></span><br><span class="line">            mViews.add(view);</span><br><span class="line">            mRoots.add(root);</span><br><span class="line">            mParams.add(wparams);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// do this last because it fires off messages to start doing things</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                root.setView(view, wparams, panelParentView, userId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                <span class="comment">// BadTokenException or InvalidDisplayException, clean up.</span></span><br><span class="line">                <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    removeViewLocked(index, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 WindowManagerGlobal 中，首先会创建 ViewRootImpl，将 View、ViewRootImpl 和 LayoutParams 放入到 List 中，后边更新 UI 使用，三者因下标相同，所以可以一一对应。然后调用 <a href="#ViewRootImpl-setView"><code>ViewRootImpl.setView()</code></a> 加载 View。</p>
<h4 id="ViewRootImpl-setView"><a href="#ViewRootImpl-setView" class="headerlink" title="ViewRootImpl.setView()"></a>ViewRootImpl.setView()</h4><p><code>ViewRootImpl.setView()</code> 方法比较长，提取了一下其中的关键逻辑：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title class_">ViewParent</span>, View.AttachInfo.Callbacks, ThreadedRendererDrawCallbacks &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">    View mView;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mView == <span class="literal">null</span>) &#123;</span><br><span class="line">                mView = view;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">                requestLayout();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 通过 IPC 通信通知 WMS 渲染界面</span></span><br><span class="line">                res = mWindowSession.addToDisplayAsUser(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                            getHostVisibility(), mDisplay.getDisplayId(), userId, mTmpFrame,</span><br><span class="line">                            mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                            mAttachInfo.mDisplayCutout, inputChannel,</span><br><span class="line">                            mTempInsets, mTempControls);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 省略...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestLayout</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">            checkThread();</span><br><span class="line">            mLayoutRequested = <span class="literal">true</span>;</span><br><span class="line">            scheduleTraversals();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">checkThread</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CalledFromWrongThreadException</span>(</span><br><span class="line">                    <span class="string">&quot;Only the original thread that created a view hierarchy can touch its views.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>setView()</code> 方法中，首先调用了 <code>requestLayout()</code>，然后通过 IPC 通信，通知 WMS 渲染界面。跟进 <code>requestLayout()</code> 方法中，首先需要检查当前线程，然后调用 <code>scheduleTraversals()</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title class_">ViewParent</span>, View.AttachInfo.Callbacks, ThreadedRendererDrawCallbacks &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            doTraversal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">TraversalRunnable</span> <span class="variable">mTraversalRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TraversalRunnable</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">scheduleTraversals</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">            mTraversalScheduled = <span class="literal">true</span>;</span><br><span class="line">            mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">            mChoreographer.postCallback(</span><br><span class="line">                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="literal">null</span>);</span><br><span class="line">            notifyRendererOfFramePending();</span><br><span class="line">            pokeDrawLockIfNeeded();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doTraversal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">            mTraversalScheduled = <span class="literal">false</span>;</span><br><span class="line">            mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">                Debug.startMethodTracing(<span class="string">&quot;ViewAncestor&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            performTraversals();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">                Debug.stopMethodTracing();</span><br><span class="line">                mProfile = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其调用链为 <code>setView()</code> -&gt; <code>requestLayout()</code> -&gt; <code>scheduleTraversals()</code> -&gt; <code>doTraversal()</code> -&gt; <code>performTraversals()</code>。</p>
<h4 id="View-的绘制流程"><a href="#View-的绘制流程" class="headerlink" title="View 的绘制流程"></a>View 的绘制流程</h4><p>接下来就是 View 树的绘制流程，我们进到 <code>performTraversals()</code> 方法中看一下关键代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title class_">ViewParent</span>, View.AttachInfo.Callbacks, ThreadedRendererDrawCallbacks &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performTraversals</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">        performLayout(lp, mWidth, mHeight);</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">        performDraw();</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>View 的绘制分三步，测量、布局和绘制，详细内容将在另一边文章展开。(TODO)</p>
<h2 id="相关面试题"><a href="#相关面试题" class="headerlink" title="相关面试题"></a>相关面试题</h2><h3 id="为什么要要设计-Window？"><a href="#为什么要要设计-Window？" class="headerlink" title="为什么要要设计 Window？"></a>为什么要要设计 Window？</h3><ol>
<li>使 Activity 的职责更加单一。</li>
<li>View 树的控制封装到 Window 之后，Activity 只需要管理 Window 即可。</li>
</ol>
<h3 id="子线程是否可以更新-UI？"><a href="#子线程是否可以更新-UI？" class="headerlink" title="子线程是否可以更新 UI？"></a>子线程是否可以更新 UI？</h3><p>从 ActivityThread 的源码得知，View 的绘制是发生在 Activity onResume 生命周期之后的，所以在 <code>onCreate()</code> 方法、第一次进入 <code>onResume()</code> 方法时，都是可以在其他线程更新 UI 的。<br>关于子线程更新 UI 的更多问题，可以转到<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/xzeihP6nexNyBLjMuxraJg">这篇文章</a>看下。</p>
<h3 id="可以在-Activity-onCreate-中获取到-View-的宽和高吗，在-Activity-onResume-中呢？"><a href="#可以在-Activity-onCreate-中获取到-View-的宽和高吗，在-Activity-onResume-中呢？" class="headerlink" title="可以在 Activity.onCreate() 中获取到 View 的宽和高吗，在 Activity.onResume() 中呢？"></a>可以在 <code>Activity.onCreate()</code> 中获取到 View 的宽和高吗，在 <code>Activity.onResume()</code> 中呢？</h3><ol>
<li>如果直接获取或者用 Handler 获取，是无法获取到 View 的宽高的，因为 View 的绘制流程是在 <code>onResume()</code> 方法之后的，但是如果采用延时 Handler 是可能会获取到宽高的。使用 <code>View.post()</code> 方法可以获取到宽高。</li>
<li>如果直接获取或者用 Handler 获取，在第一次进入到 <code>onResume()</code> 方法时，跟在 <code>onCreate()</code> 的情况是一样的，当再次进入到 <code>onResume()</code> 方法，是可以获取到的。同样，使用 <code>View.post()</code> 方法可以获取到宽高。</li>
</ol>
<h3 id="为什么使用-View-post-方法可以获取到宽高？"><a href="#为什么使用-View-post-方法可以获取到宽高？" class="headerlink" title="为什么使用 View.post() 方法可以获取到宽高？"></a>为什么使用 <code>View.post()</code> 方法可以获取到宽高？</h3><p>首先我们先看下 <code>View.post()</code> 的逻辑：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">View</span> <span class="keyword">implements</span> <span class="title class_">Drawable</span>.Callback, KeyEvent.Callback, AccessibilityEventSource &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">post</span><span class="params">(Runnable action)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">AttachInfo</span> <span class="variable">attachInfo</span> <span class="operator">=</span> mAttachInfo;</span><br><span class="line">        <span class="keyword">if</span> (attachInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> attachInfo.mHandler.post(action);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Postpone the runnable until we know on which thread it needs to run.</span></span><br><span class="line">        <span class="comment">// Assume that the runnable will be successfully placed after attach.</span></span><br><span class="line">        getRunQueue().post(action);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>onCreate()</code> 中 attachInfo 为空，则先将 runnable 放入到队列中，然后这个队列中的任务会在 <code>performTraversals()</code> 中执行。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title class_">ViewParent</span>, View.AttachInfo.Callbacks, ThreadedRendererDrawCallbacks &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performTraversals</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">        <span class="comment">// Execute enqueued actions on every traversal in case a detached view enqueued an action</span></span><br><span class="line">        getRunQueue().executeActions(mAttachInfo.mHandler);</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">        performLayout(lp, mWidth, mHeight);</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">        performDraw();</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 <code>View.post()</code> 添加的任务，是在 View 绘制流程的开始阶段，将所有任务重新发送到消息队列的尾部，此时相关任务的执行已经在 View 绘制任务之后，即 View 绘制流程已经结束，此时便可以正确获取到 View 的宽高了。</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Android/">Android</a><a class="link-muted mr-2" rel="tag" href="/tags/%E6%BA%90%E7%A0%81/">源码</a><a class="link-muted mr-2" rel="tag" href="/tags/View/">View</a><a class="link-muted mr-2" rel="tag" href="/tags/Window/">Window</a><a class="link-muted mr-2" rel="tag" href="/tags/WMS/">WMS</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/12/22/android-ams/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Android AMS 原理解读</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/12/14/android-touch-event/"><span class="level-item">Android 触摸事件分发机制</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "120902dc173d1e260d7cb3743ca3260f",
            repo: "qihuan92.github.io",
            owner: "qihuan92",
            clientID: "63af65c81b81a45c85dd",
            clientSecret: "f332d0d8c42fecaf6ad773673656cf9bb39ccc70",
            admin: ["qihuan92"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Window-存在的意义"><span class="level-left"><span class="level-item">1</span><span class="level-item">Window 存在的意义</span></span></a></li><li><a class="level is-mobile" href="#Activity、Window-和-View-的关系"><span class="level-left"><span class="level-item">2</span><span class="level-item">Activity、Window 和 View 的关系</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Activity"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">Activity</span></span></a></li><li><a class="level is-mobile" href="#Window"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">Window</span></span></a></li><li><a class="level is-mobile" href="#WindowManager"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">WindowManager</span></span></a></li><li><a class="level is-mobile" href="#DecorView"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">DecorView</span></span></a></li><li><a class="level is-mobile" href="#ViewRootImpl"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">ViewRootImpl</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Activity-是如何通过-Window-将-View-展示出来的"><span class="level-left"><span class="level-item">3</span><span class="level-item">Activity 是如何通过 Window 将 View 展示出来的</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-performLaunchActivity"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">1. performLaunchActivity()</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Activity-attach"><span class="level-left"><span class="level-item">3.1.1</span><span class="level-item">Activity.attach()</span></span></a></li><li><a class="level is-mobile" href="#Activity-setContentView"><span class="level-left"><span class="level-item">3.1.2</span><span class="level-item">Activity.setContentView()</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-handleResumeActivity"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">2. handleResumeActivity()</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#WindowManager-加载-DecorView"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">WindowManager 加载 DecorView</span></span></a></li><li><a class="level is-mobile" href="#WindowManagerGlobal-加载-View"><span class="level-left"><span class="level-item">3.2.2</span><span class="level-item">WindowManagerGlobal 加载 View</span></span></a></li><li><a class="level is-mobile" href="#ViewRootImpl-setView"><span class="level-left"><span class="level-item">3.2.3</span><span class="level-item">ViewRootImpl.setView()</span></span></a></li><li><a class="level is-mobile" href="#View-的绘制流程"><span class="level-left"><span class="level-item">3.2.4</span><span class="level-item">View 的绘制流程</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#相关面试题"><span class="level-left"><span class="level-item">4</span><span class="level-item">相关面试题</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#为什么要要设计-Window？"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">为什么要要设计 Window？</span></span></a></li><li><a class="level is-mobile" href="#子线程是否可以更新-UI？"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">子线程是否可以更新 UI？</span></span></a></li><li><a class="level is-mobile" href="#可以在-Activity-onCreate-中获取到-View-的宽和高吗，在-Activity-onResume-中呢？"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">可以在 Activity.onCreate() 中获取到 View 的宽和高吗，在 Activity.onResume() 中呢？</span></span></a></li><li><a class="level is-mobile" href="#为什么使用-View-post-方法可以获取到宽高？"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">为什么使用 View.post() 方法可以获取到宽高？</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-07T08:49:54.000Z">2022-11-07</time></p><p class="title"><a href="/2022/11/07/android-apt-activity-starter/">从 startActivity 谈谈 APT 的应用</a></p><p class="categories"><a href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-31T01:48:05.000Z">2021-12-31</time></p><p class="title"><a href="/2021/12/31/iterm-shortcut-key/">iTerm 快捷键速查</a></p><p class="categories"><a href="/categories/%E7%BB%88%E7%AB%AF/">终端</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-27T08:55:36.000Z">2021-12-27</time></p><p class="title"><a href="/2021/12/27/android-handler/">Android Handler 原理分析</a></p><p class="categories"><a href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-22T09:05:48.000Z">2021-12-22</time></p><p class="title"><a href="/2021/12/22/android-ams/">Android AMS 原理解读</a></p><p class="categories"><a href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-14T09:07:51.000Z">2021-12-14</time></p><p class="title"><a href="/2021/12/14/android-window/">Android Window 机制</a></p><p class="categories"><a href="/categories/Android/">Android</a></p></div></article></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">QiHuan</a><p class="is-size-7"><span>&copy; 2024 齐欢</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/qihuan92"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>